<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHG Protocol Analysis (Audio Enabled)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization (NEW FEATURE) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui; background-color: #121212; color: #e0e0e0; padding: 2rem; }
        .container { max-width: 900px; margin: 0 auto; background-color: #1e1e1e; padding: 2rem; border-radius: 0.75rem; }
        h1, h2, h3 { color: #00b64c; margin-bottom: 0.5rem; }
        h3 { margin-top: 1.5rem; border-bottom: 1px solid #333; padding-bottom: 0.5rem; }
        .table-container { overflow-x: auto; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2a2a2a; color: #00b64c; }
        .button-group { margin-top: 1rem; }
        .button-group button { 
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: bold; 
            transition: all 0.2s; 
        }
        .loading-text { color: #ff7e00; }
        /* Style for the chart container */
        #chart-container { 
            width: 100%; 
            max-width: 400px; 
            margin: 1.5rem auto; 
            padding: 1rem;
            background: #2a2a2a;
            border-radius: 0.5rem;
        }
        /* Styles for the scope sections */
        .scope-section { transition: opacity 0.3s; }
        .scope-section.hidden-scope { 
            opacity: 0.15; 
            pointer-events: none;
            /* Use a combination of max-height/padding collapse if needed for full removal */
        }
    </style>
</head>
<body>
    <div class="container shadow-lg">
        <h1 class="text-3xl font-bold mb-4">Understanding the Carbon Footprint: The GHG Protocol's Three Scopes</h1>

        <p class="mb-6 text-gray-400">This page provides the simplified framework behind the **Decarbonization Lever** simulation. To track and manage climate change, engineers and organizations use the **Greenhouse Gas (GHG) Protocol**, which relies on scientific guidelines set by the IPCC. The core idea is to put all sources of emissions into three distinct **"buckets"** or **Scopes**.</p>
        
        <!-- VISUAL REINFORCEMENT: Scopes Diagram (Generated by Gemini) -->
        <div class="my-4 text-center p-4 rounded-lg bg-neutral-800">
            [Image of GHG Protocol Scopes 1 2 and 3 Diagram]
        </div>

        <!-- Interactive TTS Section -->
        <div class="button-group">
            <button id="generate-audio" class="bg-[#0077b6] hover:bg-[#0056b3] text-white">
                ðŸ”Š Generate & Play Audio Summary
            </button>
            <p id="audio-status" class="mt-2 text-sm text-gray-400"></p>
        </div>
        <audio id="audio-player" controls class="mt-4 hidden w-full"></audio>

        <!-- MICRO-INTERACTIVITY: Scope Filter Toggles -->
        <div class="button-group flex flex-wrap justify-center gap-2 mb-8 p-3 bg-neutral-800 rounded-lg">
            <span class="text-sm font-semibold text-gray-300 mr-2 self-center">Filter View:</span>
            <button id="toggle-all" class="bg-gray-600 hover:bg-gray-500 text-white text-sm">Show All</button>
            <button id="toggle-scope1" class="bg-red-600 hover:bg-red-500 text-white text-sm">Scope 1</button>
            <button id="toggle-scope2" class="bg-yellow-600 hover:bg-yellow-500 text-white text-sm">Scope 2</button>
            <button id="toggle-scope3" class="bg-green-600 hover:bg-green-500 text-white text-sm">Scope 3</button>
        </div>

        <!-- NEW FEATURE: Scope Visualization -->
        <div id="chart-container">
            <h2 class="text-xl font-bold text-center text-white mb-4">Typical Emissions Breakdown</h2>
            <canvas id="scopeChart"></canvas>
        </div>
        
        <!-- Content starts here -->
        
        <div id="scope-content">
            <div id="scope-1-content" class="scope-section" data-scope="1">
                <h3 class="text-xl font-semibold mt-6">Scope 1: Direct Emissions ("In My Backyard")</h3>
                <p>Scope 1 includes all emissions that come directly from sources **owned or controlled** by the entity doing the counting. If the fuel is burned on-site, it's Scope 1.</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Source Type</th><th>Explanation</th><th>Concrete Examples</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>**Combustion**</td><td>Burning fuel (like gasoline or natural gas) in owned vehicles or equipment.</td><td>Running a backup diesel generator; burning gas in a campus boiler.</td></tr>
                            <tr><td>**Fugitive Emissions**</td><td>Intentional or unintentional leaks of GHGs.</td><td>Leaks from air conditioning units (HFCs/refrigerants); methane leaks from natural gas pipelines.</td></tr>
                            <tr><td>**Process Emissions**</td><td>GHGs released during industrial processes, not combustion.</td><td>CO<sub>2</sub> released from the calcination of limestone during cement production.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="scope-2-content" class="scope-section" data-scope="2">
                <h3 class="text-xl font-semibold mt-6">Scope 2: Energy Consumption Emissions ("My Utility Bill")</h3>
                <p>Scope 2 covers emissions from the generation of **purchased electricity, heat, or steam**. The pollution happens at the power plant, but the responsibility for those emissions belongs to the organization that consumes the energy.</p>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Source Type</th><th>Explanation</th><th>Concrete Examples</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>**Purchased Electricity**</td><td>Power consumed for lighting, computers, and running machinery.</td><td>Lights in a university classroom; server cooling in a data center.</td></tr>
                            <tr><td>**Purchased Steam/Heat**</td><td>Using external steam or hot water networks for heating buildings.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="scope-3-content" class="scope-section" data-scope="3">
                <h3 class="text-xl font-semibold mt-6">Scope 3: Value Chain Emissions ("Everything Else")</h3>
                <p>Scope 3 is the largest and most complex category, covering all **indirect emissions** that occur in the organizationâ€™s value chain. For most businesses and universities, **Scope 3 represents over 70% of the total carbon footprint.**</p>
                <ul>
                    <li class="mb-2"><strong class="text-yellow-400">Upstream Activities (Suppliers):</strong> Manufacturing the computer you bought; processing the food served in the cafeteria.</li>
                    <li class="mb-2"><strong class="text-yellow-400">Downstream Activities (Customers):** Student and employee commuting; waste disposal; end-of-life treatment of products.</li>
                </ul>
                
                <!-- TIERS Explanation (Now fully visible and math fixed) -->
                <div class="p-4 mt-6 bg-neutral-700 border-l-4 border-yellow-500 rounded-r-lg">
                    <h4 class="font-bold text-lg text-white mb-2">Engineering Detail: The Importance of Tiers</h4>
                    <p class="text-sm text-gray-300">
                        Because Scope 3 is so massive, the GHG Protocol breaks down data collection into Tiers, based on accuracy and effort:
                        <ul class="list-disc list-inside mt-2 ml-4 space-y-1">
                            <li>**Tier 1 (Lowest Accuracy):** Uses industry-average data (e.g., using a government-supplied CO<sub>2</sub> factor for a generic laptop). This is quick and cheap.</li>
                            <li>**Tier 2 (Medium Accuracy):** Uses specific data for the purchased good or service (e.g., using an emissions factor specific to your region's utility grid).</li>
                            <li>**Tier 3 (Highest Accuracy):** Requires supplier-specific data collection (e.g., surveying the exact factory that made your goods). This is the gold standard but requires significant effort.</li>
                        </ul>
                        Higher tiers give you better results but require more **influence** over your supply chain.
                    </p>
                </div>
            </div>
        </div>

        <!-- GWP/CO2e Explanation (FIXED MATH) -->
        <div class="p-4 mt-6 bg-neutral-800 border-l-4 border-accent rounded-r-lg">
            <h4 class="font-bold text-lg text-white">Engineering Note: Why We Say CO<sub>2</sub>e</h4>
            <p class="text-sm text-gray-300 mt-1">
                The IPCC tracks more than just Carbon Dioxide (CO<sub>2</sub>). Gases like Methane (CH<sub>4</sub>) and Nitrous Oxide (N<sub>2</sub>O) are far more powerful greenhouse gases. We use the metric **Global Warming Potential (GWP)** to convert these gases into a single comparable unit: **Carbon Dioxide Equivalent (CO<sub>2</sub>e).** For instance, Methane has a GWP of approximately 28 over 100 years, meaning one ton of Methane warms the planet as much as 28 tons of CO<sub>2</sub>. CO<sub>2</sub>e allows engineers to compare all pollution in one universal currency.
            </p>
        </div>
        
        <h3 class="text-xl font-semibold mt-6">The Decarbonization Lever in Action</h3>
        <p>The purpose of our interactive tool is to illustrate the strategic importance of addressing all three Scopes. The challenge is clear: **you can't win the race against climate change by only focusing on Scope 1 and 2.** Our simulation lets you see how impactful those tricky Scope 3 changes truly are.</p>
    </div>

    <script>
        // =======================================================
        // TTS GENERATION LOGIC (EXISTING)
        // =======================================================

        // Helper function to convert base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Helper function to convert PCM data to WAV Blob
        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            
            // RIFF identifier
            writeString(view, 0, 'RIFF');
            // file length (excluding RIFF identifier and file length)
            view.setUint32(4, 36 + pcmData.byteLength, true);
            // 'WAVE' identifier
            writeString(view, 8, 'WAVE');
            // 'fmt ' chunk
            writeString(view, 12, 'fmt ');
            // chunk length (16 for PCM)
            view.setUint32(16, 16, true);
            // audio format (1 for PCM)
            view.setUint16(20, 1, true);
            // number of channels (1)
            view.setUint16(22, 1, true);
            // sample rate
            view.setUint32(24, sampleRate, true);
            // byte rate (SampleRate * NumChannels * BitsPerSample/8)
            view.setUint32(28, sampleRate * 2, true);
            // block align (NumChannels * BitsPerSample/8)
            view.setUint16(32, 2, true);
            // bits per sample
            view.setUint16(34, 16, true);
            // 'data' chunk
            writeString(view, 36, 'data');
            // data length
            view.setUint32(40, pcmData.byteLength, true);

            // Write PCM data
            const pcmBytes = new Uint8Array(pcmData);
            for (let i = 0; i < pcmData.byteLength; i++) {
                view.setUint8(44 + i, pcmBytes[i]);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // =======================================================
        // CHART RENDERING LOGIC
        // =======================================================
        function renderScopeChart() {
            const ctx = document.getElementById('scopeChart').getContext('2d');
            
            // Typical distribution data (reflecting the 70% Scope 3 claim)
            const data = {
                labels: ['Scope 1 (Direct)', 'Scope 2 (Energy)', 'Scope 3 (Value Chain)'],
                datasets: [{
                    label: 'Typical GHG Emission Breakdown',
                    data: [10, 20, 70], // 10% Scope 1, 20% Scope 2, 70% Scope 3
                    backgroundColor: [
                        '#ff0000', // Red for direct emissions
                        '#ffff00', // Yellow for purchased energy
                        '#00b64c'  // Green for complex value chain (your accent color)
                    ],
                    hoverOffset: 4
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e0e0e0', // Light text color for dark mode
                                font: {
                                    family: 'Fira Code',
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                                }
                            }
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            };

            new Chart(ctx, config);
        }

        // =======================================================
        // SCOPE FILTER LOGIC (FIXED)
        // =======================================================

        function initScopeFilters() {
            // Select all sections that can be filtered
            const allSections = document.querySelectorAll('.scope-section');
            const buttonIds = ['toggle-all', 'toggle-scope1', 'toggle-scope2', 'toggle-scope3'];
            
            const updateFilter = (filter) => {
                allSections.forEach(section => {
                    const scope = section.dataset.scope;
                    if (filter === 'all' || scope === filter) {
                        section.classList.remove('hidden-scope');
                    } else {
                        section.classList.add('hidden-scope');
                    }
                });

                // Update button styles: Highlight the active button
                buttonIds.forEach(id => {
                    const button = document.getElementById(id);
                    if (button) {
                        const buttonFilter = button.id.includes('all') ? 'all' : button.dataset.scope;
                        if (buttonFilter === filter) {
                            button.classList.add('opacity-100', 'ring-2', 'ring-white'); // Add visual highlight
                            button.classList.remove('opacity-50');
                        } else {
                            button.classList.add('opacity-50');
                            button.classList.remove('opacity-100', 'ring-2', 'ring-white');
                        }
                    }
                });
            };
            
            // Set initial state to 'Show All'
            updateFilter('all');

            // Attach listeners to buttons
            buttonIds.forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    // Set data-scope attribute for easy retrieval (only needed for scope buttons)
                    if (id.startsWith('toggle-scope')) {
                        button.dataset.scope = id.slice(-1);
                    }
                    button.addEventListener('click', () => {
                        const filterValue = button.id.includes('all') ? 'all' : button.dataset.scope;
                        updateFilter(filterValue);
                    });
                }
            });
        }


        // =======================================================
        // DOM READY INITIATOR
        // =======================================================

        document.addEventListener('DOMContentLoaded', () => {
            renderScopeChart();
            initScopeFilters(); // Initialize the new filter controls

            const generateButton = document.getElementById('generate-audio');
            const audioPlayer = document.getElementById('audio-player');
            const audioStatus = document.getElementById('audio-status');
            const apiKey = ""; // Canvas will inject API key
            const model = "gemini-2.5-flash-preview-tts";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            // The full text to be narrated by multiple speakers
            const narrationText = `
                TTS the following analysis on the three carbon emission scopes:
                
                Scope 1: This category is "In My Backyard." It covers emissions that an organization directly owns or controls. Think of burning fuel in campus vehicles or the natural gas used in a building's heating system. These are the simplest to measure and manage.
                
                Scope 2: This is the "My Utility Bill" category. It accounts for emissions created by the power company when you consume purchased electricity, heat, or steam. Even though the smoke stack is off-site, you are responsible for the pollution your consumption causes.
                
                Scope 3: This is "Everything Else," and it is often the largest category, covering the entire value chain. Examples include the emissions from employee commuting, manufacturing the laptops you buy, and transporting goods to your suppliers. Strategic decarbonization must tackle these complex indirect sources.
            `;

            // Setup for the Multi-Speaker TTS call
            const payload = {
                contents: [{ parts: [{ text: narrationText }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        multiSpeakerVoiceConfig: {
                            speakerVoiceConfigs: [
                                { speaker: "Scope 1", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Charon" } } },
                                { speaker: "Scope 2", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } },
                                { speaker: "Scope 3", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Zephyr" } } }
                            ]
                        }
                    }
                },
                model: model // gemini-2.5-flash-preview-tts
            };

            generateButton.addEventListener('click', async () => {
                generateButton.disabled = true;
                audioStatus.textContent = "Loading... Generating audio summary of 3 scopes. This may take a moment.";
                audioPlayer.classList.add('hidden');
                audioPlayer.src = ''; // Clear previous audio

                try {
                    // Retry logic for API call with exponential backoff
                    let response;
                    for (let i = 0; i < 3; i++) { // Try up to 3 times
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break;

                        if (i < 2) { // Wait before retrying
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        } else {
                            throw new Error(`API call failed after multiple retries with status: ${response.status}`);
                        }
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (!audioData || !mimeType || !mimeType.startsWith("audio/L16")) {
                        throw new Error("Invalid or missing audio data in API response.");
                    }

                    // Extract the sample rate from the mimeType (e.g., audio/L16;rate=24000)
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    if (!rateMatch || rateMatch.length < 2) {
                         throw new Error("Could not determine sample rate from MIME type.");
                    }
                    const sampleRate = parseInt(rateMatch[1], 10);

                    // 1. Convert base64 audio data to ArrayBuffer
                    const pcmArrayBuffer = base64ToArrayBuffer(audioData);
                    
                    // 2. Convert PCM ArrayBuffer to a playable WAV Blob
                    const wavBlob = pcmToWav(pcmArrayBuffer, sampleRate);
                    
                    // 3. Create a URL for the Blob and load it into the player
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    audioStatus.textContent = "Audio ready! Press play to hear the 3 Scopes explained.";
                    
                } catch (error) {
                    console.error("TTS Generation Error:", error);
                    audioStatus.textContent = `âŒ Error: ${error.message}. Check console for details.`;
                } finally {
                    generateButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
